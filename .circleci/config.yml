version: 2.1

jobs:
    build:
        docker:
            - image: cimg/node:17.7.2
        working_directory: ~/dteruel-website
        steps:
            - checkout
            - run:
                name: "checking node and npm version"
                command: node --version
            - run: npm --version
            - run:
                name: Node Sass
                command: npm install node-sass

            - run:
                name: Rebuild Node Sass
                command: sudo npm rebuild node-sass
            - run:
                name: "Installing dependencies"
                command: npm install
            - run: npm run build
    deploy:
        machine:
            enabled: true
        working_directory: ~/dteruel-website
        environment:
            HEROKU_APP: "dt-wesite"
        steps:
            - checkout
            - run:
                name: Setup Heroku
                command: bash .circleci/setup-heroku.sh # run a script to set up Heroku

            - run:
                command: |
                    git push heroku circleci-project-setup:main
                    # heroku run rake db:migrate
                    sleep 5 # sleep for 5 seconds to wait for dynos
                    # heroku restart

workflows:
    version: 2
    build-and-deploy:
        jobs:
            - build
            - deploy:
                    requires:
                        - build
                    filters:
                        branches:
                            only: circleci-project-setup
